# 生産管理システム実習

## 目的: (PLC の機能をつかって) 製造指示、実績収集、生産設備状態監視の基礎技術を学び、クラウド連携を含む簡易生産管理システムを構築する。

## 生産管理システムとは

Wikipedia:
> 生産管理（せいさんかんり、英: production control）とは、経営計画あるいは販売計画に従って生産活動を計画し、
> 組織し、統制する総合的な管理活動のこと。その内容は、生産計画、生産組織および、生産統制である。これらのうち、
> 一つないし二つだけの管理は、生産管理の部分管理とみなされる。 

経営計画や販売計画はスコープの範囲外です。また「生産組織」（どういう組織にするか）や「生産統制」（どういうルールにするか）というのは、経営に依存するため、これもスコープの範囲外です。

授業で扱うのは、計画にしたがってきちんと製品が生産されているかを管理するシステムです。
FA システムに対して

- 製造指示をして、
- 実績を収集して、
- 設備の状態を監視 (モニタリング)

するシステムを目指します。

 (ネットワークを介して) PLC によって構築された製造ラインに指示を出して、それがきちんと実行されているかをわかるように (可視化、見え
る化) しよう、ということです。

## 市販の生産管理システム例

https://hp.adap.kke.co.jp/adaplp/

# 実習で使用する環境

## RaspberryPi 3 modelB+
- https://www.raspberrypi.com/products/raspberry-pi-3-model-b-plus/

Raspberry Pi を使います。

### Node-Red

ブロックをつなげるだけでオンラインサービスが作れるツール。（なかなかわかりにくい。使ってみるのが早い。）
Node-Red は無料で利用でき、Windows や Mac でも動作しますが、管理者権限が必要なケースもあるため、今回は Raspberry Pi 上で実行します。

- https://nodered.org/
- 日本のコミュニティ
  - https://nodered.jp/

## 三菱製 PLC 

はじめにレジスタに値を書き込む簡単なプログラムをセットアップし、そのレジスタをネットワーク越しに Node-Red (Rasberrry Pi) から読み取ります。また書き込めるかを確認します。
授業の後半ではワーク製造ラインに対して同様のことができるか、やってみます。

## Google Firebird

グーグルのクラウドサービス。無料で使えるデータベースです。

## ネットワークカメラ

(余裕があれば) 応用編として、 Node-Red からネットワークカメラを操作して、ラインの状態を外部からモニタリングできるようにしてみます。

# RaspberryPi セットアップ

- 有線接続

## 最新の状態にする

```
apt-get update  (管理データベースを最新にする)
apt-get upgrade (管理データベースにしたがってソフトウェア本体を最新にする)
<再起動>
```

## Node-Red

Node-Red をセットアップします。

? Settings file ‣ /home/plcuser/.node-red/settings.js<RET>

```
> User Security
> =============
> Do you want to setup user security? No

> Projects
> ========
> The Projects feature allows you to version control your flow using a local git repository.
> Do you want to enable the Projects feature? No
```

そのあとは全部エンター (リターン) で OK

## Node-Red の起動と終了

### 起動方法

```
$ node-red-start
```

同一ネットワーク (LAN) からブラウザで、http://[**RaspberryPi の IP アドレス]**:1880/ でアクセスします。

### 終了方法

終了はターミナルで Ctrl+C キーを押し、表示を停止します。プログラムは動いたままので、*node-red-stop* コマンドで停止します。

```
$ node-red-stop
```

### Node-red の画面構成

<center>
  <img src="./images/node-red-capture.png" width="80%">
</center>

Node-Red は Flow 作成エリアにノードパレットからノードをドラッグ＆ドロップし、ノード間をつなぐことで機能を組み立てていきます。

**例題：** inject ノードと debug ノードを使ってみよう。


## Raspberry Pi の IP アドレスを確認する

```
% ip
```

# PLC のセットアップ

PLC をセットアップします。
ネットワーク越しに PLC にアクセスするためには設定が必要です。
通常 IP アドレスによって接続の可否を設定します。

## TCP と UDP と IP アドレス

GXWorks の設定画面に現れるキーワード **TCP** と **UDP** と **ポート番号** と **IP アドレス** について説明します。

**IP アドレス**
IP アドレスは各機器をネットワーク上で識別するための番号です。実はこれは半分正解、半分まちがっています。

IP アドレスは正確にはネットワークインタフェースを識別します。たとえば PC に２つのネットワークのクチ (例えば Ethernet と WiFi) を持っていれば、
それぞれに IP アドレスは付与されます。

PLC は通常、ネットワークのクチは一つでしょうから、IP アドレスで一意に特定できると思ってかまいません。

**TCP** と **UDP**

TCP と UDP は通信方法の名前でお互い通親戚の関係にあります。

使い方というか特徴が異なります。
TCP は、おなじ情報が流れてきても、情報の順番が正しくなくても、正しく整列して届くようにしてくれます。
そしてちゃんと相手に伝わることを保証しています。
その代償として処理が重い (つまり動作が遅い) です。

UDP は、おなじ情報がながれてきてもそのまま流すし、順番がズレてもお構いなしだし、相手に伝わったかどうかも確認しません。
その代わり、処理が軽い (つまり動作が速い) です。

今回は UDP を使います。

**ポート番号**

IP アドレスはインタフェースにつく、と言いました。しかしパソコン上ではいろんなプログラムが通信をしています。プログラムを区別・識別するのがポート番号です。

世界中で利用されているような有名なプログラムは番号が決まっています。メールを送るプログラムは 25 番を使います。ファイルを送るプログラムは 20 番と 21 板を使います。

みなさんが一番利用しているウェブ http://なんとか/ は 80 番を使います。https://なんとか/ は 443 番です。

有名なポート番号を PLC のプログラムに割り当てると、ハッカーに攻撃のターゲットになったりするので避けましょう。
テストやオレオレプログラムでは 10000 より上など大きな番号を使うことが多いです。
/etc/services によく使われるポート番号が載っています。

**課題１：** PLC プログラムセットアップ  
**課題２：** Rasberry Pi からのアクセスを許可するように設定する

# MCPROTOCOL ノード

Node-Red に MCPROTOCOL ノードをインストールする。
